# ê¸°ì¡´ ë°°í¬ íŒŒì¼ì— HPA ê¸°ëŠ¥ ì¶”ê°€
apiVersion: apps/v1
kind: Deployment
metadata:
  name: univ-frontend
spec:
  replicas: 2  # HPAê°€ ê´€ë¦¬í•˜ë¯€ë¡œ ì´ˆê¸°ê°’ (í”„ë¡ íŠ¸ì—”ë“œë„ 2ê°œë¡œ ì‹œì‘)
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      imagePullSecrets:
      - name: reg-cred
      containers:
      - name: frontend
        image: reg-univ.kr.ncr.ntruss.com/my-frontend:v1
        ports:
        - containerPort: 80
        # ğŸ”¥ HPAë¥¼ ìœ„í•œ ë¦¬ì†ŒìŠ¤ ìš”ì²­/ì œí•œ (í˜„ì‹¤ì ì¸ ê°’ìœ¼ë¡œ ì¡°ì •)
        resources:
          requests:
            cpu: 200m      # 0.2 CPU ì½”ì–´ (Nginx + ì •ì íŒŒì¼)
            memory: 128Mi  # 128MB RAM
          limits:
            cpu: 500m      # 0.5 CPU ì½”ì–´ ìµœëŒ€
            memory: 256Mi  # 256MB RAM ìµœëŒ€
        # í—¬ìŠ¤ì²´í¬ ì¶”ê°€
        livenessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 10
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: frontend-svc
spec:
  selector:
    app: frontend
  ports:
  - port: 80
    targetPort: 80
  type: NodePort
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: univ-backend
spec:
  replicas: 2  # HPAê°€ ê´€ë¦¬í•˜ë¯€ë¡œ ì´ˆê¸°ê°’
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      imagePullSecrets:
      - name: reg-cred
      containers:
      - name: backend
        image: reg-univ.kr.ncr.ntruss.com/my-backend:v5
        ports:
        - containerPort: 8080
        # ğŸ”¥ HPAë¥¼ ìœ„í•œ ë¦¬ì†ŒìŠ¤ ìš”ì²­/ì œí•œ (Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì í•©í•œ ê°’)
        resources:
          requests:
            cpu: 500m      # 0.5 CPU ì½”ì–´ (Spring Boot ê¸°ë³¸ ìš”êµ¬ì‚¬í•­)
            memory: 512Mi  # 512MB RAM (JVM í™ + ë©”íƒ€ìŠ¤í˜ì´ìŠ¤)
          limits:
            cpu: 1000m     # 1 CPU ì½”ì–´ ìµœëŒ€
            memory: 1Gi    # 1GB RAM ìµœëŒ€
        env:
        - name: SPRING_DATASOURCE_URL
          value: "jdbc:mysql://192.168.30.6:3306/univ_db?useSSL=false&serverTimezone=Asia/Seoul&characterEncoding=UTF-8"
        - name: SPRING_DATASOURCE_USERNAME
          value: "taekjunnn"
        - name: SPRING_DATASOURCE_PASSWORD
          value: "Melontype123!"
        # í—¬ìŠ¤ì²´í¬ ì¶”ê°€ (Actuator ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©)
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 3
          failureThreshold: 3
---
apiVersion: v1
kind: Service
metadata:
  name: backend-svc
spec:
  selector:
    app: backend
  ports:
  - port: 80
    targetPort: 8080
  type: NodePort
  # ì„¸ì…˜ ì–´í”¼ë‹ˆí‹° ì¶”ê°€ (ê°™ì€ í´ë¼ì´ì–¸íŠ¸ëŠ” ê°™ì€ Podë¡œ)
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 1800  # 30ë¶„
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: univ-ingress
  annotations:
    kubernetes.io/ingress.class: alb
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}]'
    # ë°±ì—”ë“œ í—¬ìŠ¤ì²´í¬ ê²½ë¡œ ì¶”ê°€
    alb.ingress.kubernetes.io/healthcheck-path: /actuator/health
spec:
  rules:
  - http:
      paths:
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: backend-svc
            port:
              number: 80
      # Actuator ë©”íŠ¸ë¦­ ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€ (ëª¨ë‹ˆí„°ë§ìš©)
      - path: /actuator
        pathType: Prefix
        backend:
          service:
            name: backend-svc
            port:
              number: 80
      - path: /
        pathType: Prefix
        backend:
          service:
            name: frontend-svc
            port:
              number: 80
---
# ğŸš€ ë°±ì—”ë“œ HPA ì„¤ì •
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: univ-backend-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: univ-backend
  minReplicas: 2
  maxReplicas: 15  # ë” ë§ì€ ìŠ¤ì¼€ì¼ë§ í—ˆìš©
  metrics:
  # CPU ì‚¬ìš©ë¥  ê¸°ë°˜ ìŠ¤ì¼€ì¼ë§
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70  # CPU 70% ì´ˆê³¼ ì‹œ ìŠ¤ì¼€ì¼ ì•„ì›ƒ
  # ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥  ê¸°ë°˜ ìŠ¤ì¼€ì¼ë§
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80  # ë©”ëª¨ë¦¬ 80% ì´ˆê³¼ ì‹œ ìŠ¤ì¼€ì¼ ì•„ì›ƒ
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 60  # 1ë¶„ ì•ˆì •í™” ê¸°ê°„
      policies:
      - type: Percent
        value: 100  # í•œ ë²ˆì— ìµœëŒ€ 100% (2ë°°) ì¦ê°€
        periodSeconds: 60
      - type: Pods
        value: 2    # í•œ ë²ˆì— ìµœëŒ€ 2ê°œ Pod ì¶”ê°€
        periodSeconds: 60
    scaleDown:
      stabilizationWindowSeconds: 300  # 5ë¶„ ì•ˆì •í™” ê¸°ê°„ (ì²œì²œíˆ ì¶•ì†Œ)
      policies:
      - type: Percent
        value: 50   # í•œ ë²ˆì— ìµœëŒ€ 50% ê°ì†Œ
        periodSeconds: 60
      - type: Pods
        value: 1    # í•œ ë²ˆì— ìµœëŒ€ 1ê°œ Pod ì œê±°
        periodSeconds: 60
---
# ğŸš€ í”„ë¡ íŠ¸ì—”ë“œ HPA ì„¤ì •
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: univ-frontend-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: univ-frontend
  minReplicas: 2  # í”„ë¡ íŠ¸ì—”ë“œë„ ìµœì†Œ 2ê°œë¡œ ì¦ê°€
  maxReplicas: 8  # ë” ë§ì€ ìŠ¤ì¼€ì¼ë§ í—ˆìš©
  metrics:
  # CPU ì‚¬ìš©ë¥  ê¸°ë°˜ ìŠ¤ì¼€ì¼ë§ (í”„ë¡ íŠ¸ì—”ë“œëŠ” ë” ë³´ìˆ˜ì )
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 80  # CPU 80% ì´ˆê³¼ ì‹œ ìŠ¤ì¼€ì¼ ì•„ì›ƒ
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 120  # 2ë¶„ ì•ˆì •í™” ê¸°ê°„
      policies:
      - type: Percent
        value: 50   # í•œ ë²ˆì— ìµœëŒ€ 50% ì¦ê°€
        periodSeconds: 60
      - type: Pods
        value: 1    # í•œ ë²ˆì— ìµœëŒ€ 1ê°œ Pod ì¶”ê°€
        periodSeconds: 60
    scaleDown:
      stabilizationWindowSeconds: 300  # 5ë¶„ ì•ˆì •í™” ê¸°ê°„
      policies:
      - type: Pods
        value: 1    # í•œ ë²ˆì— ìµœëŒ€ 1ê°œ Pod ì œê±°
        periodSeconds: 120